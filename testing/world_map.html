<!DOCTYPE html>

<meta charset="utf-8">

<style>

    body {
        /* try to make this more local */
        overflow-x: hidden;
    }

    #viz {
        width: 100%;
        height: 600px;
    }

    #viz #map {
        z-index: -1;
        width: 100%;
        height: 100%;
        background-color: #243452;
    }

    #viz #graticule {
        fill: none;
        stroke: #777;
        stroke-width: .5px;
        stroke-opacity: .5;
    }

    #viz #reset-listener {
        fill: none;
        pointer-events: visible;
    }

    #viz path {
        transition: fill 2000ms;
    }

    #viz #countries {
        transition: fill .2s;
        fill: #4B77C9;
        stroke-width: .2px;
        stroke: #243452;
    }

    #viz #countries .selected {
        fill: steelblue;
    }

    #viz #countries .unselected {
        fill: #354C78;
    }

    #viz #programs {
        fill: #C9A14B;
        stroke: none;
        stroke-width: 0px;
        cursor: pointer;
    }

    #viz #programs path {
        transition: fill 2000ms;
    }

    #viz #programs .unselected {
        opacity: .4;
    }

    #viz .student {
        fill: #C9A14B;
        color: #ffc445 !important;
    }

    #viz .tournament {
        fill: #aa087c;
        color: #ff24c1 !important;
    }

    #viz #focus {
        padding: 20px;
        position: absolute;
        background-color: steelblue;
        color: black;
        top: 35%;
        /* height: 50%; */
        width: 40%;
    }

    #viz #focus img {
        height: 200px;
        width: 200px;
        object-fit: cover;
    }

    #viz #focus-header {
        display: flex; /* or inline-flex */
        align-items: flex-end;
    }

    #viz #focus-header-info {
        padding: 0px 15px;
    }

    #viz #focus-header-info p {
        margin: auto;
        padding: .1em 0em;
        font-size: 2.5em;
    }

    #viz #focus-header #focus-flavor-text p:first-letter {
        float: left;
        font-size: 45px;
        line-height: 1;
        font-weight: bold;
        margin-right: 9px;
    }

    #viz #focus-header-info #location {
        margin: auto;
        padding: .3em 0em;
        font-size: 1.5em;
        font-style: italic;
        color: white;
    }

    #viz #overlay {
        position: absolute;
        box-sizing: border-box;
        background: rgba(0,0,0, .5);
        transition: opacity 1000ms;
        color: white;
        top: 0%;
        left: 0%;
        width: inherit;
        height: inherit;
    }

    #viz #overlay #overlay-text{
        color: white;
        margin: auto;
        padding: 30%;
        width: 50%;
        height: 50%;
        position: relative;
    }


</style>

<body>

    <div id="viz">

        <svg id="map" ></svg>
        <!-- <div id="legend">
            <p class="student"> 
                Yellow dots represent Westfield students. 
            </p>
            <p class="tournament"> 
                Magenta dots represent tournaments that Westfield students attend. 
            </p>
        </div> -->
        <div id="overlay">
            <div id="overlay-text">
                <p class="student" >Yellow dots represent Westfield students.</p>
                <p class="tournament" >Magenta dots represent tournaments that Westfield students attend.</p>
                <p>Click on a dot to see details.</p>
            </div>
        </div>

    </div>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v3.min.js"></script>
    <script src="https://unpkg.com/d3-geo@1"></script>
    <script src="https://unpkg.com/d3-geo-polygon@1"></script>

    <script>

    const dot_size = 4

    viz = d3.select("#viz")

    viz.select("#overlay")
        .on("click", function() {
            d3.select(this).style("opacity", 0)
            setTimeout(() => { d3.select(this).remove(); }, 500);
        })

    map_elements = viz.select("#map").append("g")

    const width = parseInt(viz.style("width")),
        height = parseInt(viz.style("height"))

    projection = {

        waterman: d3.geoPolyhedralWaterman()
                    .rotate( [20, 0] )
                    .scale(150)
                    .translate( [width/2, height/2 ]),

        airocean: d3.geoAirocean()
                    .scale(50)
                    .translate( [width/2, height/2 ]),

        patterson: d3.geoNaturalEarth1()
                    .rotate( [-10, 0] )
                    .scale(180)
                    .translate( [width/2, height/2 ]),

        mercator: d3.geoMercator()
                    .scale( 50 )
                    .rotate( [0,0] )
                    .center( [0, 0] )
                    .translate( [width/2,height/2] )
    }

    const urls = {

        shapes: "https://raw.githubusercontent.com/tk-sheldo/westfield-map/c5e1780a78d9ab6683121ea771c1a9540cb00006/100m_countries.json",

        point_data: "https://raw.githubusercontent.com/tk-sheldo/westfield-map/4889efce42885402c7c2c0008d2ac31f8c764f6c/json_processing/joined.json",

    }

    const geoPathGenerator = d3.geoPath()
        .projection(projection.waterman);

    const graticule = d3.geoGraticule();

    var zoom = d3.zoom()
        .scaleExtent([1, 8])
        .on("zoom", zoomed);

    function zoomed() {

        let transform = d3.event.transform

        viz.select("#graticule").attr("transform", transform)
        viz.select("#countries").attr("transform", transform)
        viz.select("#programs")
            .attr("transform", transform)
        x = viz.select("#programs").selectAll("path")
        x.attr( "d", geoPathGenerator.pointRadius(dot_size) )
        //viz.selectAll(".program").attr( "d", geoPathGenerator.pointRadius(1) )
    }

    class Focus {

        constructor(side, data) {

            this.side = side
            this.data = data.properties

            this.speed = 1000
            this.div = viz.append("div")
                .attr("id", "focus")

            let focus_width = parseInt(this.div.style("width"))
            
            if (side == 'L') {

                this.offscreen_pos = (- (focus_width + 20)) + "px"
                this.reading_pos = "40px"
            }
            else {

                this.offscreen_pos = width + 20 + "px"
                this.reading_pos = (width / 2) + 40 + "px"
            }

            this.div.style("left", this.offscreen_pos)

            this.fill_data()

        }

        fill_data() {

            let header = this.div.append("div").attr("id", "focus-header")

            header.append("img")
                .attr("src", this.data.imageURL)
                .attr("alt", this.data.name + " image")

            let header_info = header.append("div").attr("id", "focus-header-info")

            header_info.append("p").html(this.data.name)
            header_info.append("p")
                .attr("id", "location")
                .html(this.data.location_name + ", " + this.data.country)

            this.div.append("div").attr("id", "focus-flavor-text")
                .append("p").html(this.data.text)

        }

        enter() {

            this.div.transition()
                .duration(this.speed)
                .style("left", this.reading_pos);
        }

        leave() {

            this.div.transition()
                .duration(this.speed)
                .style("left", this.offscreen_pos);

            setTimeout(() => { this.div.remove(); }, this.speed);
        }

    }

    let focus = null;

    // load data for map
    d3.queue()
        .defer(d3.json, urls.shapes)
        .defer(d3.json, urls.point_data)
        .await(ready);

    // draws map
    function ready(error, shapes, point_data) {

        if (error) throw error;

        // graticules
        const graticule = d3.geoGraticule();

        viz.select("#map").append("path")
                .datum(graticule)
                .attr("id", "graticule")
                .attr("d", geoPathGenerator);

        // draw countries
        viz.select( 'svg' ).append( "g" )
            .attr("id", "countries")
            .selectAll( "path" )
            // Bind TopoJSON data elements
            .data(topojson.feature(shapes, shapes.objects.ne_110m_admin_0_countries).features) 
            .enter().append("path")
                .attr("d", geoPathGenerator)
                .attr("id", function(d) {
                    return d.properties.ADM0_A3;
                })
        
        // waterman only
        viz.select("#ATA").remove()

        viz.select("#map").append('rect')
            .attr("id", "reset-listener")
            .attr("width", width)
            .attr("height", height)
            .on("click", reset);

        viz.select("#map").append("g")
            .attr("id", "prog2")
        .selectAll("circle")
            .data(point_data.features)
            .enter()
            .append("circle")
            .style("fill", "green")
            .attr("cx", function(d) {
                return projection.waterman(d.geometry.coordinates)[0]
            })
            .attr("cy", function(d) {
                return projection.waterman(d.geometry.coordinates)[1]
            })
            .attr("r", dot_size)

        // draw points
        viz.select('#map').append('g')
            .attr('id', 'programs')
        .selectAll('path')
            .data(point_data.features)
            .enter()
            .append( 'path' )
            .attr('class', 'program')
            .attr('class', function(d) {

                data = d

                console.log(d)

                if (d.properties.type == "student") {
                    return "student"
                }
                else {
                    return "tournament"
                }
            })
            .attr( "d", geoPathGenerator )
            .attr( "d", geoPathGenerator.pointRadius(dot_size) )
            .on("click", function(d) {

                if (focus !== null) { focus.leave() }

                country_id = "#" + d.properties.ADM0_A3

                viz.select("#countries").selectAll("path")
                    .classed("unselected", true);

                viz.select("#countries").select(country_id)
                    .classed("unselected", false)
                    .classed("selected", true)

                viz.select("#programs").selectAll("path")
                    .classed("unselected", true)
                
                d3.select(this).classed("unselected", false)

                //TODO: prevent the selected program from fading, issue with 'this'

                //const highlight_height = 200
                //country_bbox = d3.select(country_id).node().getBBox()
                //scale_factor = Math.floor( 200 / country_bbox.height )
                //d3.select(country_id).clone().attr("id", "country_clone"); 

                // calc which side focus box should enter from 
                let entrance = 'L'
                if (this.getBBox().x < width/2) { entrance = 'R' }

                // create and bring in focus box
                focus = new Focus(entrance, d)
                focus.enter()

                zoom_to(d)


            })

            

    }

    function zoom_to(d) {

        let bounds = geoPathGenerator.bounds(d)

        let dx = bounds[1][0] - bounds[0][0],
            dy = bounds[1][1] - bounds[0][1],
            x = (bounds[0][0] + bounds[1][0]) / 2,
            y = (bounds[0][1] + bounds[1][1]) / 2,
            scale = Math.max(1, Math.min(5, 0.9 / Math.max(dx / width, dy / height))),
            translate = null

        scale = 3

        // adjust centering of zoom to compensate for focus box
        if (focus.side == 'R') {
            translate = [width / 4 - scale * x, height / 2 - scale * y];
        }
        else {
            translate = [ (3/4 * width) - scale * x, height / 2 - scale * y];
        }

        // zoom
        viz.select("#map").transition()
            .duration(1500)
            .call( zoom.transform, 
                d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale) );
    }

    function reset() {

        if (focus !== null) { focus.leave() }

        viz.select("#countries").selectAll("path")
            .classed("selected", false).classed("unselected", false);

        viz.select("#programs").selectAll("path")
            .classed("unselected", false);


        viz.select("#map").transition()
            .duration(750)
            .call( zoom.transform, d3.zoomIdentity );

    }



    </script>
</body>
</html>